<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub OAuth æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            margin: 10px;
            background: #333;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background: #555;
        }
        .github {
            background: #333;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .error {
            background: #ffebee;
            border-left-color: #f44336;
            color: #c62828;
        }
        .success {
            background: #e8f5e8;
            border-left-color: #4caf50;
            color: #2e7d32;
        }
        pre {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ™ GitHub OAuth æ¸¬è©¦é é¢</h1>
        
        <div class="status">
            <h3>ğŸ“‹ æ¸¬è©¦æ­¥é©Ÿï¼š</h3>
            <ol>
                <li>ç¢ºèª GitHub OAuth App è¨­å®šæ­£ç¢º</li>
                <li>é»æ“Šä¸‹æ–¹ "GitHub ç™»å…¥æ¸¬è©¦" æŒ‰éˆ•</li>
                <li>æˆæ¬Šæ‡‰ç”¨å­˜å–æ‚¨çš„ GitHub å¸³è™Ÿ</li>
                <li>æª¢æŸ¥æ˜¯å¦æˆåŠŸè¿”å›ä¸¦é¡¯ç¤ºç”¨æˆ¶è³‡è¨Š</li>
            </ol>
        </div>

        <div id="authInfo" class="status" style="display: none;"></div>

        <h3>ğŸ”— OAuth ç«¯é»æ¸¬è©¦ï¼š</h3>
        
        <button class="btn github" onclick="testGitHubLogin()">
            ğŸ™ GitHub ç™»å…¥æ¸¬è©¦
        </button>
        
        <button class="btn" onclick="checkAuthStatus()">
            âœ… æª¢æŸ¥èªè­‰ç‹€æ…‹
        </button>
        
        <button class="btn" onclick="testProviders()">
            ğŸ” æª¢æŸ¥æä¾›å•†
        </button>

        <h3>ğŸ“Š API å›æ‡‰ï¼š</h3>
        <pre id="apiResponse">é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ¸¬è©¦ API...</pre>

        <h3>ğŸ“ é‡è¦è¨­å®šè³‡è¨Šï¼š</h3>
        <div class="status">
            <p><strong>Client ID:</strong> Ov23liDJENPQkcVi1TIh</p>
            <p><strong>å›å‘¼ URL:</strong> http://localhost:5002/auth/callback/github</p>
            <p><strong>æˆæ¬Šç¯„åœ:</strong> user:email, read:user</p>
        </div>

        <h3>ğŸ› ï¸ GitHub OAuth App è¨­å®šæª¢æŸ¥æ¸…å–®ï¼š</h3>
        <div class="status">
            <input type="checkbox"> Application name: "AIè³‡è¨Šå®‰å…¨RAG Chatæ©Ÿå™¨äºº"<br>
            <input type="checkbox"> Homepage URL: "http://localhost:5002"<br>
            <input type="checkbox"> Authorization callback URL: "http://localhost:5002/auth/callback/github"<br>
            <input type="checkbox"> Client ID å·²æ­£ç¢ºè¨­å®šåœ¨ .env æª”æ¡ˆ<br>
            <input type="checkbox"> Client Secret å·²æ­£ç¢ºè¨­å®šåœ¨ .env æª”æ¡ˆ
        </div>
    </div>

    <script>
        async function testGitHubLogin() {
            try {
                showStatus('æ­£åœ¨å–å¾— GitHub æˆæ¬Š URL...', 'info');
                
                const response = await fetch('/auth/login/github');
                const data = await response.json();
                
                if (data.authorization_url) {
                    showApiResponse(data);
                    showStatus('å³å°‡è·³è½‰åˆ° GitHub æˆæ¬Šé é¢...', 'success');
                    
                    // è·³è½‰åˆ° GitHub æˆæ¬Šé é¢
                    setTimeout(() => {
                        window.location.href = data.authorization_url;
                    }, 2000);
                } else {
                    showStatus('å–å¾—æˆæ¬Š URL å¤±æ•—', 'error');
                    showApiResponse(data);
                }
            } catch (error) {
                showStatus('è«‹æ±‚å¤±æ•—: ' + error.message, 'error');
                console.error('Error:', error);
            }
        }

        async function checkAuthStatus() {
            try {
                showStatus('æª¢æŸ¥èªè­‰ç‹€æ…‹...', 'info');
                
                const response = await fetch('/auth/status');
                const data = await response.json();
                
                showApiResponse(data);
                
                if (data.authenticated) {
                    showStatus(`å·²ç™»å…¥: ${data.user.name} (${data.user.email})`, 'success');
                } else {
                    showStatus('æœªç™»å…¥', 'info');
                }
            } catch (error) {
                showStatus('æª¢æŸ¥ç‹€æ…‹å¤±æ•—: ' + error.message, 'error');
                console.error('Error:', error);
            }
        }

        async function testProviders() {
            try {
                showStatus('æª¢æŸ¥ OAuth æä¾›å•†...', 'info');
                
                const response = await fetch('/auth/providers');
                const data = await response.json();
                
                showApiResponse(data);
                
                const githubConfigured = data.providers?.github?.configured;
                if (githubConfigured) {
                    showStatus('GitHub OAuth å·²æ­£ç¢ºé…ç½® âœ…', 'success');
                } else {
                    showStatus('GitHub OAuth é…ç½®æœ‰å•é¡Œ âŒ', 'error');
                }
            } catch (error) {
                showStatus('æª¢æŸ¥æä¾›å•†å¤±æ•—: ' + error.message, 'error');
                console.error('Error:', error);
            }
        }

        function showStatus(message, type) {
            const authInfo = document.getElementById('authInfo');
            authInfo.style.display = 'block';
            authInfo.innerHTML = message;
            authInfo.className = 'status ' + type;
        }

        function showApiResponse(data) {
            document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
        }

        // æª¢æŸ¥æ˜¯å¦æœ‰ OAuth å›å‘¼åƒæ•¸
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            if (error) {
                showStatus(`OAuth éŒ¯èª¤: ${error}`, 'error');
            } else if (code && state) {
                showStatus('æ”¶åˆ° OAuth å›å‘¼ï¼Œæ­£åœ¨è™•ç†...', 'info');
                // é€™è£¡é€šå¸¸æœƒç”±æ‚¨çš„æ‡‰ç”¨è™•ç†ï¼Œä¸éœ€è¦é¡å¤–å‹•ä½œ
                setTimeout(checkAuthStatus, 1000);
            }
        });
    </script>
</body>
</html>

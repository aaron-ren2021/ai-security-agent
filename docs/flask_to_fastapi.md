# Flask → FastAPI 遷移計畫（Planner 版 — 無程式碼）

>
---

## 目的

將既有 Flask 應用穩健、漸進地遷移至 FastAPI，達成：提升性能、強化型別驗證、自動化 API 文件，並在遷移過程保持可回滾、最小停機、可觀察性。

---

## 範圍與前提假設

* 範圍：後端 API（HTTP + WebSocket）、上傳/下載、背景任務、認證與 DB 存取邏輯。
* 假設：現有應用具備自動化測試（單元 + 基礎 E2E），且 CI/CD 可做分流部署；團隊可在短期內支援少量的同步/非同步改動。

---

## 主要角色與責任

* **遷移負責人（Owner）**：統籌進度、決策、跨團隊協調。
* **工程負責人（Engineers）**：按 endpoint 執行遷移、撰寫 schema、重構資料存取層。
* **測試工程師（QA）**：建立回歸測試、對照測試、自動化驗證。
* **DevOps / 平台工程師**：負責路由/流量分流、部署模組、監控儀表板、回滾機制。
* **產品 / 服務主管**：定義可接受的風險與上線窗口（維運時段）。

---

## 高層時程（範例 8 週計劃 — 可依專案規模調整）

* **Week 0 — 準備**：清單建立、測試補強、選定 Pilot endpoint。
* **Week 1–2 — 骨架與基礎設施**：建立 FastAPI skeleton、CI pipeline、監控指標、健康檢查。
* **Week 3–4 — Pilot 上線**：遷移 1–3 個低風險 endpoint，做影子流量或少量實際流量測試。
* **Week 5 — 漸進擴大**：依優先順序按批次遷移更多 endpoint（每週一批或按風險分級）。
* **Week 6–7 — 影響範圍收斂**：完成高風險 endpoint 遷移（Auth、支付、檔案）。
* **Week 8 — 收尾與拆除**：回收舊代碼、清理配置、文件更新。

---

## 詳細步驟（每個階段的具體 checklist）

### A. 準備階段（Discovery）

1. **盤點**：列出所有路由與行為（method、input/outputs、auth、依賴的中介件或外部服務）。
2. **分級風險**：按「關鍵性」與「複雜度」把 route 分為低/中/高風險。
3. **測試補強**：為關鍵流程補齊自動化測試（優先：回傳相依、邊界條件、錯誤處理）。
4. **相依檢查**：列出第三方套件或驅動是否需替換（例如 DB driver、cache client）。
5. **定義衡量指標**：延遲 p50/p95、錯誤率、資源使用、吞吐量、依賴呼叫延遲。
6. **制定回滾條件**：明確哪些指標觸發立即回滾（例如：錯誤率 X% 以上、p95 超過基準兩倍）。

### B. 建構基礎設施（Platform）

1. **建立 FastAPI skeleton**：含基本中介、健康檢查、error-mapping、API 文件入口。
2. **CI/CD Pipeline 更新**：新增 FastAPI 的建置、測試與部署流程，保留可回滾版本。
3. **監控與告警**：新增儀表板與 alert（錯誤率、延遲、流量、資源）。
4. **路由策略設計**：選擇分流方式（反向代理子路徑、子域名、API Gateway），並設計逐步上線的流量策略（ex: 5% → 25% → 100%）。

### C. Pilot（最小可行遷移）

1. **選擇目標**：一到三個低風險、讀取導向的 endpoint。
2. **同步行為驗證**：對照舊系統結果（格式、狀態碼、錯誤訊息）。
3. **上線模式**：先在 staging 做影子測試，再使用分流將少量真實流量導到新服務。
4. **收集資料**：比較延遲、錯誤、資源與日誌。
5. **評估結果**：若達到可接受標準，進入擴大遷移；若未達標，修正或回滾。

### D. 漸進遷移（成批推進）

1. **批次定義**：依風險/關聯性把 endpoint 分成批次（例如：批次 A = 公開 read API；批次 B = 需要認證但單一 DB 寫入；批次 C = 高風險 financial flow）。
2. **每批流程（for each batch）**：

   * 實作 Pydantic-style schema（即定義輸入/輸出契約）。
   * 完成單元與回歸測試；執行負載測試與延遲測試。
   * 部署到 staging，執行影子流量測試。
   * 以小比例（例如 5%）導流到生產，觀察 24–72 小時。
   * 持續觀察 7 天（或產品要求的穩定期），逐步提升流量到 100%。
3. **治理與紀錄**：每完成一批，記錄變更、學習點與調整策略。

### E. 切換與拆除（Cutover）

1. **確認目標指標**：流量 100%、錯誤率與延遲在允收範圍內。
2. **逐步移除舊路由**：在確保沒有流量被導回後，從 Flask 中移除相應 endpoint。
3. **下架與清理**：清理舊代碼、CI 任務與不再使用的中介件。
4. **資料庫注意**：確保 schema 與 migration 可向後相容（若做 DB 改動，先做兼容性層）。

### F. 後遷移（Stabilize）

1. **全面回歸測試**：確認整體服務一致性。
2. **優化**：針對監控指標進行調優（連線池、worker 數、資源配比）。
3. **文件與訓練**：更新內部 Runbook、API 文件，對團隊做知識傳承。

---

## 回滾計畫（當事態不佳時的急用步驟）

1. **立即行動條件**：預先定義的 SLO 被觸發（例如：錯誤率瞬間升高超過門檻、重大功能錯誤）。
2. **回滾流程**：

   * 立刻用負載平衡器/NGINX/API Gateway 把該路由流量導回舊服務。
   * 若問題為配置或依賴，嘗試熱修配置；若為核心邏輯錯誤，優先回滾路由。
   * 通知利害關係人與啟動 postmortem。
3. **回滾後驗證**：確認流量穩定、錯誤率恢復、資料一致性未受損。

---

## 測試矩陣（每個 endpoint 必做項目）

* **單元測試**：邏輯行為與邊界。
* **契約測試**：輸入/輸出格式與狀態碼一致性。
* **回歸測試**：與舊系統的行為比對。
* **壓力/負載測試**：p50/p95/p99、資源使用。
* **混沌測試（選項）**：模擬依賴降級或高延遲。

---

## 監控與 SLO 建議

* **必備指標**：總請求量、錯誤率（4xx/5xx）、延遲 p50/p95/p99、上游依賴延遲、資源使用（CPU/RAM）。
* **告警門檻**：例如錯誤率 > 3% 或 p95 > 基線 * 2 觸發高優先告警。
* **追蹤**：保留分散追蹤（Trace ID）以便追溯跨服務請求。

---

## 溝通計畫

* **例行同步**：每週一次進度會議（Owner、工程、QA、DevOps、產品）。
* **上線通知**：每次 batch 上線前 24 小時內發送變更通知，含預期影響、回滾條件。
* **重大事故流程**：定義通報名單與回報頻率（每 15 分鐘 / 30 分鐘）。

---

## 經驗教訓與風險緩解（常見風險與對策）

* **風險：同步 DB 成為瓶頸** → 緩解：保留同步呼叫或限制同時併發、並列評估 async driver 改造期程。
* **風險：第三方 lib 不支援 async** → 緩解：以 thread pool 隔離或替換套件。
* **風險：驗證邏輯差異** → 緩解：以契約測試驅動變更，並在測試中包含格式差異檢查。

---

## 每個 endpoint 的遷移模板（移動到執行工具時可填寫）

* Endpoint 名稱：
* 風險等級（低/中/高）：
* 依賴資源（DB、第三方 API、內部服務）：
* 測試項目（列出必要測試）：
* 預估工作量（人日）：
* 流量分批策略（例：5% → 25% → 100%）：
* 回滾條件：

---

## 估算工期與人力（粗估）

* 小型服務（<20 個 endpoint）：2–4 週（1–2 人合作）。
* 中型服務（20–100 endpoint）：6–12 週（跨 3–6 人）。
* 大型服務（>100 endpoint）：視情況分階段，預估 3 個月以上，需專案管理。

---

## 交付產出（每階段需提交）

* 準備階段：路由清單、風險分級表、測試缺口報告。
* 基礎建構：CI/CD 更新紀錄、監控面板樣板、健康檢查清單。
* Pilot：Pilot 報告（性能比較、錯誤分析、決策紀錄）。
* 批次遷移：每批的上線報告與回滾紀錄。
* 結案：最終移轉報告、學習筆記、Runbook 更新。

---

如果你想，我可以接著：

* 把上述每個步驟變成可打勾的 PR 模板與 issue checklist，自動化分派給對應角色；或
* 幫你把 `路由清單` 轉成每個 endpoint 的遷移模板（CSV/表格），只要貼上路由摘要我就幫你拆分優先順序。

我會以前瞻性與同理心陪你把這個計畫落實——說明你想先做哪一項，我立刻幫你把它具體化。
